@page "/Issues"
@using LANCommander.Server.Data
@using Microsoft.EntityFrameworkCore;
@using SortDirection = LANCommander.Server.Data.Enums.SortDirection
@attribute [Authorize(Roles = RoleService.AdministratorRoleName)]
@inject DatabaseServiceFactory DatabaseServiceFactory
@inject NavigationManager NavigationManager
@inject IMessageService MessageService
@inject ILogger<Index> Logger

<PageHeader Title="Issues" />

<DataTable
    @ref="Table"
    TItem="Issue"
    LoadData="LoadData"
    Size="@TableSize.Small"
    Responsive>
    <RightToolbar>
        <Button OnClick="() => Add()" Type="ButtonType.Primary">Add Issue</Button>
    </RightToolbar>
    <Columns>
        <BoundDataColumn Property="i => i.Game.Title" Title="Game" />
        <BoundDataColumn Property="i => i.CreatedOn" Title="Created On" />
        <BoundDataColumn Property="i => i.CreatedBy != null ? i.CreatedBy.UserName : String.Empty" Title="Created By" />
        <BoundDataColumn Property="i => i.ResolvedOn" Title="Resolved On" />
        <BoundDataColumn Property="i => i.ResolvedBy != null ? i.ResolvedBy.UserName : String.Empty" Title="Resolved By" />
        
        <DataColumn TData="string" Title="Status">
            @if (context.ResolvedOn == null)
            {
                <Badge Color="BadgeColor.Blue" Text="Open" />
            }
            else
            {
                <Badge Status="BadgeStatus.Success" Text="Resolved" />
            }
        </DataColumn>

        <DataActions>
            <a href="/Issues/@(context.Id)" class="ant-btn ant-btn-primary">Edit</a>

            <Popconfirm OnConfirm="() => Delete(context)" Title="Are you sure you want to delete this issue?">
                <Button Icon="@IconType.Outline.Close" Type="ButtonType.Text" Danger />
            </Popconfirm>
        </DataActions>
    </Columns>
</DataTable>

 @code {
    IssueService IssueService;

    IEnumerable<Issue> Issues { get; set; } = new List<Issue>();

    DataTable<Issue> Table;

    async Task<PaginatedResults<Issue>> LoadData(int pageIndex, int pageSize, string search)
    {
        using (var issueService = DatabaseServiceFactory.Create<IssueService>())
        {
            return await issueService
                .SortBy(i => i.CreatedOn, SortDirection.Descending)
                .Include(
                    i => i.Game,
                    i => i.CreatedBy,
                    i => i.UpdatedBy,
                    i => i.ResolvedBy
                )
                .PaginateAsync(i => true, pageIndex, pageSize);
        }
    }

    void Add()
    {
        NavigationManager.NavigateTo("/Issues/Add");
    }

    async Task Delete(Issue issue)
    {
        using (var issueService = DatabaseServiceFactory.Create<IssueService>())
        {
            try
            {
                await issueService.DeleteAsync(issue);

                MessageService.Success("Issue was successfully deleted!");
                
                Table.ReloadData();
            }
            catch (Exception ex)
            {
                MessageService.Error("Could not delete issue!");
                Logger.LogError(ex, "Could not delete issue!");
            }
        }
    }
}
