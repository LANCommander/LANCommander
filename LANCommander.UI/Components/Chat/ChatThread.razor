@using System.Collections.Specialized
@using LANCommander.SDK.Services
@using Microsoft.AspNetCore.Components.Web.Virtualization
@inject IChatClient ChatClient
@namespace LANCommander.UI.Components

<Flex Direction="FlexDirection.Vertical">
    <div style="flex-grow: 1;">
        @if (_thread != null)
        {
            <Virtualize Items="_thread.MessageGroups" Context="messageGroup">
                <ChatMessageGroup
                    @key="messageGroup.Id"
                    UserId="@messageGroup.UserId"
                    UserName="@messageGroup.UserName"
                    StartedOn="@messageGroup.StartedOn.LocalDateTime">
                    @foreach (var message in messageGroup.Messages)
                    {
                        <ChatMessage Id="@message.Id" Content="@message.Content" SentOn="@message.SentOn"/>   
                    }
                </ChatMessageGroup>
            </Virtualize>
        }
    </div>

    <ChatMessageInput ThreadId="@Id" />
</Flex>

@code {
    [Parameter] public Guid Id { get; set; }
    
    SDK.Models.ChatThread? _thread;
    
    protected override async Task OnParametersSetAsync()
    {
        if (_thread == null || _thread.Id != Id)
        {
            _thread = await ChatClient.GetThreadAsync(Id);
            
            _thread.MessageGroups.CollectionChanged += MessageGroupsOnCollectionChanged;
            
            await ChatClient.GetMessagesAsync(Id);
        }
    }

    void MessageGroupsOnCollectionChanged(object? sender, NotifyCollectionChangedEventArgs e)
        => InvokeAsync(StateHasChanged);
}